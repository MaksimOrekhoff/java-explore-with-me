# Explore With Me
## Репозиторий приложения-афишы анонсов событий и мероприятий.
Сервис служит для подбора вариантов проведения досуга, обсуждения и посещение мероприятий. Этот проект является многомодульным приложением на REST-архитектуре с использованием Spring Boot. Вкючает в себя два микросервиса ***ewm-service*** и ***stats-server***, обменивающихся данными по HTTP, с собственными БД, извлечение данных из которых посредством SQL-запросов. Для маппинга сущностей используется одна из самых популярных реализаций спецификации JPA - библиотека ***Hibernate***. Проект поднимается в контейнерах по инструкции из docker-compose.yml. Одной из особенностей приложения является оставление комментариев: есть возможность отвечать на отзывы других пользователей. Для маппинга DAO из сущности Comment реализован метод с рекурсивной функцией. ***stats-server*** служит для хранения статистики. 
1. ***Архитектура БД***
![ER-диаграмма](https://user-images.githubusercontent.com/66968327/207548509-29769ed0-fae0-4a8b-a210-d72beecad9b6.png)

2.  ***Запуск приложения***
   - Установить и запустить Docker
   - Установить и запустить IntelliJ IDEA
   - Открыть проект в IntelliJ IDEA
   - Создать .jar файлы для модулей приложения через панель Maven: **Explore With Me** -> **Lifecycle** -> **package**
   - Создать контейнеры через **cmd** в папке с файлом **docker-compose.yml**, выполнив команду ```docker-compose up```
     
3.  ***ewm-service***    
    Сервис содержащий основную логику приложения. Реализован по паттерну _Controller-Service-Repository_. Основные сущности сервера: _User_, _Event_, _Request_, _Category_, _Comment_. Имеет три уровня доступа:  
    + администраторский, не требует авторизации и аутентификации
    + зарегестрированные пользователи, имеют шикорий функционал на площадке, в том числе комментирование событий
    + не зарегистрированные пользователи, имеют возможность только поверхностного просмотра информации о мероприятиях
    
    3.1. ***Эндпойнты для управления данными***:

    3.1.1. ___Для администратора___:
    + Комментарии
        - http://localhost:8080/admin/comments/{commentId}
        ***DELETE-запрос*** Удаление комментария администратором.
            - _commentId_ - id удаляемого комментария
    + События
        - http://localhost:8080/admin/events?users={users}&states={states}&categories={categories}&rangeStart={rangeStart}&rangeEnd={rangeStart}&from={from}&size={size}           
        ***GET*** Возвращает полную информацию обо всех событиях подходящих под переданные параметры запроса.
            - _users_ - список id пользователей, чьи события нужно найти
            - _states_ - список состояний в которых находятся искомые события
            - _categories_ - список id категорий в которых будет вестись поиск
            - _rangeStart_ - дата и время не раньше которых должно произойти событие
            - _rangeEnd_ - дата и время не позже которых должно произойти событие
            - _from_ - количество событий, которые нужно пропустить для формирования текущего набора
            - _size_ - количество событий в наборе
        - http://localhost:8080/admin/events/{eventId}           
        ***PUT*** Редактирование данных любого события администратором. Валидация данных не требуется.
        - http://localhost:8080/admin/events/{eventId}/publish           
        ***PATCH*** Публикация события. Обратите внимание: 
            - дата начала события должна быть не ранее чем за час от даты публикации.
            - событие должно быть в состоянии ожидания публикации
        - http://localhost:8080/admin/events/{eventId}/reject           
        ***PATCH*** Отклонение события. Обратите внимание: 
            - событие не должно быть опубликовано.
     + Категории
         - http://localhost:8080/admin/categories           
        ***POST*** Добавление новой категории. Обратите внимание: 
            - имя категории должно быть уникальным.
        - http://localhost:8080/admin/categories           
        ***PATCH*** Изменение категории. Обратите внимание: 
            - имя категории должно быть уникальным.
        - http://localhost:8080/admin/categories/{catId}           
        ***DELETE*** Удаление категории. Обратите внимание: 
            - с категорией не должно быть связано ни одного события.
     + Пользователи
         - http://localhost:8080/admin/users           
        ***POST*** Добавление нового пользователя.
        - http://localhost:8080/admin/users?ids={ids}&from={from}&size={size}         
        ***GET*** Возвращает информацию обо всех пользователях (учитываются параметры ограничения выборки), либо о конкретных (учитываются указанные идентификаторы) 
            - _ids_ - id пользователей
            - _from_ - количество событий, которые нужно пропустить для формирования текущего набора
            - _size_ - количество событий в наборе
        - http://localhost:8080/admin/users/{userId}           
        ***DELETE*** Удаление пользователя.
    + Подборки событий 
         - http://localhost:8080/admin/compilations           
        ***POST*** Добавление новой подборки событий.
        - http://localhost:8080/admin/compilations/{compilationId}           
        ***DELETE*** Удаление подборки.
        - http://localhost:8080/admin/compilations/{compilationId}/events/{eventId}         
        ***DELETE*** Удаление события из подборки.
        - http://localhost:8080/admin/compilations/{compilationId}/events/{eventId}         
        ***PATCH*** Добавление события в подборку.
        - http://localhost:8080/admin/compilations/{compilationId}/pin         
        ***DELETE*** Открепить подборку с главной страницы.
        - http://localhost:8080/admin/compilations/{compilationId}/pin         
        ***PATCH*** Закрепить подборку на главной странице.
        
    3.1.2. ___Для зарегистрированных пользователей___:
    + Комментирование
        - http://localhost:8080/users/{userId}/events/{eventId}/comments
        ***POST-запрос*** Добавление нового комментария. Обратите внимание:
            - объем комментария не может превышать 280 символов
            - Вы не сможете редактировать ваш комментарий
            - _userId_ - id пользователя
            - _eventId_ - id события
        - http://localhost:8080/users/{userId}/events/{eventId}/comments/{commentId}
        ***POST-запрос*** Ответ на комментарий другого пользователя. Обратите внимание:
            - объем комментария не может превышать 280 символов
            - Вы не сможете редактировать ваш комментарий
            - _userId_ - id пользователя
            - _eventId_ - id события
            - _commentId_ - id комментария на который Вы отвечаете
        - http://localhost:8080/users/{userId}/comments?from={from}&size={size}
        ***GET-запрос*** Получение всех комментариев пользователя. Обратите внимание:
            - _from_ - количество событий, которые нужно пропустить для формирования текущего набора
            - _size_ - количество событий в наборе
        - http://localhost:8080/users/{userId}/events/{eventId}/comments?from={from}&size={size}
        ***GET-запрос*** Получение всех комментариев события. Обратите внимание:
            - _userId_ - id пользователя
            - _eventId_ - id события
            - _from_ - количество событий, которые нужно пропустить для формирования текущего набора
            - _size_ - количество событий в наборе
        - http://localhost:8080/users/{userId}/events/{eventId}/comments/search?text={text}from={from}&size={size}
        ***GET-запрос*** Поиск по комментариям события. Обратите внимание:
            - _text_ - текст для поиска от пользователя
            - _userId_ - id пользователя
            - _eventId_ - id события
            - _from_ - количество событий, которые нужно пропустить для формирования текущего набора
            - _size_ - количество событий в наборе
        - http://localhost:8080/users/{userId}/events/{eventId}/comments/{commentId}
        ***DELETE-запрос*** Удаление комментария пользователя. Обратите внимание:
            - Вы можете удалить только свой комментарий
            - _userId_ - id пользователя
            - _eventId_ - id события
            - _commentId_ - id удаляемого комментария
    + Запросы на участие
         - http://localhost:8080/admin/users/{userId}/requests           
        ***POST*** Добавление запроса от текущего пользователя на участие в событии: 
            - нельзя добавить повторный запрос
            - инициатор события не может добавить запрос на участие в своём событии
            - нельзя участвовать в неопубликованном событии
            - если у события достигнут лимит запросов на участие - необходимо вернуть ошибку            
            - если для события отключена пре-модерация запросов на участие, то запрос должен автоматически перейти в состояние подтвержденного
        - http://localhost:8080/admin/users/{userId}/requests       
        ***GET*** Получение информации о заявках текущего пользователя на участие в чужих событиях 
            - _userId_ - id пользователя
        - http://localhost:8080/admin/users/{userId}/requests/{requestId}/cancel         
        ***PATCH*** Отмена своего запроса на участие в событии.
    + События
         - http://localhost:8080/admin/users/{userId}/events          
        ***POST*** Добавление нового события. Обратите внимание: 
            - дата и время на которые намечено событие не может быть раньше, чем через два часа от текущего момента
        - http://localhost:8080/admin/users/{userId}/events        
        ***GET*** Получение событий, добавленных текущим пользователем 
            - _userId_ - id пользователя
        - http://localhost:8080/admin/users/{userId}/events           
        ***PATCH*** Изменение события добавленного текущим пользователем.
            - изменить можно только отмененные события или события в состоянии ожидания модерации
            - если редактируется отменённое событие, то оно автоматически переходит в состояние ожидания модерации
            - дата и время на которые намечено событие не может быть раньше, чем через два часа от текущего момента
            - http://localhost:8080/admin/users/{userId}/events/{eventId}       
        ***GET*** Получение полной информации о событии добавленном текущим пользователем 
            - _userId_ - id пользователя
            - _eventId_ - id события
        - http://localhost:8080/admin/users/{userId}/events/{eventId}           
        ***PATCH*** Отмена события добавленного текущим пользователем.
            - _userId_ - id пользователя
            - _eventId_ - id события
        - http://localhost:8080/admin/users/{userId}/events/{eventId}/requests       
        ***GET*** Получение информации о запросах на участие в событии текущего пользователя 
            - _userId_ - id пользователя
            - _eventId_ - id события    
        - http://localhost:8080/admin/users/{userId}/events/{eventId}/requests/{reqId}/confirm       
        ***PATCH*** Подтверждение чужой заявки на участие в событии текущего пользователя 
            - _userId_ - id пользователя
            - _eventId_ - id события
            - _reqId_ - id события
        - http://localhost:8080/admin/users/{userId}/events/{eventId}/requests/{reqId}/refect        
        ***PATCH*** Отклонение чужой заявки на участие в событии текущего пользователя 
            - _userId_ - id пользователя
            - _eventId_ - id события
            - _reqId_ - id события
        
    3.1.3. ___Для остальных пользователей___:
    + События
         - http://localhost:8080/events?text={text}&categories={categories}&paid={paid}&rangeStart={rangeStart}&rangeEnd={rangeEnd}&onlyAvailable={onlyAvailable}&sort={sort}&from={from}&size={size}           
        ***GET*** Получение информации с возможностью фильтрации. Обратите внимание: 
            - это публичный эндпоинт, соответственно в выдаче должны быть только опубликованные события
            - текстовый поиск (по аннотации и подробному описанию) должен быть без учета регистра букв
            - если в запросе не указан диапазон дат [rangeStart-rangeEnd], то нужно выгружать события, которые произойдут позже текущей даты и времени
            - информация о каждом событии должна включать в себя количество просмотров и количество уже одобренных заявок на участие           
            - информацию о том, что по этому эндпоинту был осуществлен и обработан запрос, нужно сохранить в сервисе статистики
            - _text_ - текст для поиска в содержимом аннотации и подробном описании события
            - _categories_ - список идентификаторов категорий в которых будет вестись поиск 
            - _paid_ - поиск только платных/бесплатных событий
            - _onlyAvailable_ - только события у которых не исчерпан лимит запросов на участие
            - _sort_ - Вариант сортировки: по дате события или по количеству просмотров
            - _rangeStart_ - дата и время не раньше которых должно произойти событие
            - _rangeEnd_ - дата и время не позже которых должно произойти событие
            - _from_ - количество событий, которые нужно пропустить для формирования текущего набора
            - _size_ - количество событий в наборе
        - http://localhost:8080/events/{eventId}       
        ***GET*** Получение подробной информации об опубликованном событии по идентификатору 
            - _eventId_ - id события
        - http://localhost:8080/events/{eventId}         
        ***PATCH*** Отмена своего запроса на участие в событии.
    + Подборки событий   
        - http://localhost:8080/compilations?pinned={pinned}&from={from}&size={size}      
        ***GET*** Получение подборок событий
            - _pinned_ - искать только закрепленные/не закрепленные подборки
            - _from_ - количество элементов, которые нужно пропустить для формирования текущего набора
            - _size_ - количество элементов в наборе
        - http://localhost:8080/compilations/{compId}       
        ***GET*** Получение подробной информации об опубликованном событии по идентификатору 
            - _compId_ - id подборки    
            
4. ***stats-server***    
    Сервер статистики предназначен для сбора и хранения данных при обращениях к данным в основном сервере ***ewm-service***. При получении ***GET-запрос*** на просмотр какого-либо события, в ***stats-server*** приходит ***POST-запрос*** о получении данных и сохраняется в БД. Основные сущности: _Hit_, _Stats_. Управление данным реализовано через ***NativeQuery***.
   
